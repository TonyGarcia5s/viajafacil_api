<!doctype html>
<html lang="es">

<head>
    <title>Gestión de Agentes - ViajaFácil</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body>
    <div class="container mt-4">
        <h1>Gestión de Agentes</h1>

        <!-- Formulario -->
        <div class="mb-3">
            <label for="nombre" class="form-label">Nombre</label>
            <input type="text" class="form-control" id="nombre" placeholder="Nombre del agente" />
        </div>
        <div class="mb-3">
            <label for="correo" class="form-label">Correo</label>
            <input type="email" class="form-control" id="correo" placeholder="ejemplo@email.com" />
        </div>
        <div class="mb-3">
            <label for="experiencia" class="form-label">Años de Experiencia</label>
            <input type="number" class="form-control" id="experiencia" placeholder="Ej: 5" />
        </div>
        <div class="mb-3">
            <label for="especialidad" class="form-label">Especialidad</label>
            <input type="text" class="form-control" id="especialidad" placeholder="Especialidad del agente" />
        </div>

        <input type="hidden" id="agente_id" />

        <div class="mb-3">
            <button id="guardar" class="btn btn-primary">Guardar</button>
            <button id="actualizar" class="btn btn-success" style="display:none;">Actualizar</button>
            <button onclick="limpiarFormulario()" class="btn btn-danger">Limpiar</button>
        </div>

        <!-- Tabla -->
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Correo</th>
                        <th>Experiencia</th>
                        <th>Especialidad</th>
                        <th>Activo</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="listadatos"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:3000/api/agentes/";

        function limpiarFormulario() {
            $("#agente_id").val("");
            $("#nombre").val("");
            $("#correo").val("");
            $("#experiencia").val("");
            $("#especialidad").val("");
            $("#guardar").show();
            $("#actualizar").hide();
        }

        function cargarDatos() {
            $.get(API_URL, function (data) {
                $("#listadatos").empty();
                if (data.length > 0) {
                    data.forEach(item => {
                        $("#listadatos").append(`
                            <tr>
                                <td>${item._id}</td>
                                <td>${item.nombre || "N/A"}</td>
                                <td>${item.correo || "N/A"}</td>
                                <td>${item.experiencia_anios || 0}</td>
                                <td>${item.especialidad || "N/A"}</td>
                                <td>
                                    <button class="btn ${item.activo ? 'btn-success' : 'btn-secondary'} btn-sm"
                                        onclick="cambiarEstado('${item._id}', ${!item.activo})">
                                        ${item.activo ? 'Activo' : 'Inactivo'}
                                    </button>
                                </td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="editarDatos('${item._id}','${item.nombre}','${item.correo}','${item.experiencia_anios}','${item.especialidad}')">Editar</button>
                                    <button class="btn btn-danger btn-sm" onclick="eliminarDatos('${item._id}')">Eliminar</button>
                                </td>
                            </tr>
                        `);
                    });
                } else {
                    $("#listadatos").append('<tr><td colspan="7" class="text-center">No hay agentes registrados</td></tr>');
                }
            });
        }

        $("#guardar").click(function () {
            const nuevoAgente = {
                nombre: $("#nombre").val(),
                correo: $("#correo").val(),
                experiencia_anios: $("#experiencia").val(),
                especialidad: $("#especialidad").val()
            };

            $.ajax({
                url: API_URL,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(nuevoAgente),
                success: function () {
                    alert("Agente creado correctamente");
                    limpiarFormulario();
                    cargarDatos();
                },
                error: function (err) {
                    alert("Error al crear agente: " + err.statusText);
                }
            });
        });

        $("#actualizar").click(function () {
            const id = $("#agente_id").val();
            const datos = {
                nombre: $("#nombre").val(),
                correo: $("#correo").val(),
                experiencia_anios: $("#experiencia").val(),
                especialidad: $("#especialidad").val()
            };

            $.ajax({
                url: API_URL + id,
                type: "PUT",
                contentType: "application/json",
                data: JSON.stringify(datos),
                success: function () {
                    alert("Agente actualizado correctamente");
                    limpiarFormulario();
                    cargarDatos();
                },
                error: function (err) {
                    alert("Error al actualizar agente: " + err.statusText);
                }
            });
        });

        window.editarDatos = function (id, nombre, correo, experiencia, especialidad) {
            $("#agente_id").val(id);
            $("#nombre").val(nombre);
            $("#correo").val(correo);
            $("#experiencia").val(experiencia);
            $("#especialidad").val(especialidad);
            $("#guardar").hide();
            $("#actualizar").show();
        };

        window.eliminarDatos = function (id) {
            if (confirm("¿Desea eliminar este agente?")) {
                $.ajax({
                    url: API_URL + id,
                    type: "DELETE",
                    success: function () {
                        alert("Agente eliminado correctamente");
                        cargarDatos();
                    },
                    error: function (err) {
                        alert("Error al eliminar agente: " + err.statusText);
                    }
                });
            }
        };

        window.cambiarEstado = function (id, nuevoEstado) {
            $.ajax({
                url: API_URL + id + "/estado",
                type: "PATCH",
                contentType: "application/json",
                data: JSON.stringify({ activo: nuevoEstado }),
                success: function () {
                    cargarDatos();
                },
                error: function (err) {
                    alert("Error al cambiar estado: " + err.statusText);
                }
            });
        };

        $(document).ready(function () {
            cargarDatos();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
