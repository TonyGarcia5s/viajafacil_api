<!doctype html>
<html lang="es">

<head>
    <title>Clientes - ViajaFácil</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body>
    <header>
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" id="navId" role="tablist">
            <li class="nav-item">
                <a href="#tab1Id" class="nav-link" data-bs-toggle="tab" aria-current="page">ViajaFácil</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle active" data-bs-toggle="dropdown" href="#" role="button"
                    aria-haspopup="true" aria-expanded="false">Módulos</a>
                <div class="dropdown-menu">
                    <a class="dropdown-item active" href="cliente.html">Clientes</a>
                    <a class="dropdown-item" href="paquetes.html">Paquetes</a>
                    <a class="dropdown-item" href="cotizacion.html">Cotizaciones</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#tab4Id">Reportes</a>
                </div>
            </li>
            <li class="nav-item" role="presentation">
                <a href="#tab5Id" class="nav-link" data-bs-toggle="tab">Configuración</a>
            </li>
            <li class="nav-item" role="presentation">
                <a href="#" class="nav-link disabled" data-bs-toggle="tab">Ayuda</a>
            </li>
        </ul>
    </header>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1>Gestión de Clientes</h1>
            <button class="btn btn-success" id="btnNuevo">Agregar Cliente</button>
        </div>

        <div class="table-responsive mt-4">
            <table class="table table-hover">
                <thead class="table-primary">
                    <tr>
                        <th>Nombre</th>
                        <th>Correo</th>
                        <th>Teléfono</th>
                        <th>Clima</th>
                        <th>Presupuesto Máx</th>
                        <th>Tipo de Viaje</th>
                        <th>Fecha Registro</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="listadatos"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal para agregar/editar cliente -->
    <div class="modal fade" id="modalCliente" tabindex="-1" aria-labelledby="modalClienteLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <form id="formCliente" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalClienteLabel">Agregar Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="clienteId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nombre" class="form-label">Nombre</label>
                                <input type="text" id="nombre" class="form-control" required>
                                <small class="form-text text-muted">Ingrese el nombre completo del cliente</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="correo" class="form-label">Correo Electrónico</label>
                                <input type="email" id="correo" class="form-control" required>
                                <small class="form-text text-muted">Ingrese el correo electrónico</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="tel" id="telefono" class="form-control" required>
                                <small class="form-text text-muted">Ingrese el número de teléfono</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="clima" class="form-label">Clima Preferido</label>
                                <select class="form-select" id="clima" required>
                                    <option value="">Seleccione clima preferido</option>
                                    <option value="tropical">Tropical</option>
                                    <option value="templado">Templado</option>
                                    <option value="frio">Frío</option>
                                    <option value="cualquiera">Cualquiera</option>
                                </select>
                                <small class="form-text text-muted">Seleccione el clima preferido</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="presupuesto_max" class="form-label">Presupuesto Máximo</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" id="presupuesto_max" class="form-control" 
                                        placeholder="2000" min="0" step="100" required />
                                </div>
                                <small class="form-text text-muted">Ingrese el presupuesto máximo en dólares</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="tipo_viaje" class="form-label">Tipo de Viaje</label>
                                <select class="form-select" id="tipo_viaje" required>
                                    <option value="">Seleccione tipo de viaje</option>
                                    <option value="aventura">Aventura</option>
                                    <option value="relax">Relax</option>
                                    <option value="cultural">Cultural</option>
                                    <option value="romantico">Romántico</option>
                                    <option value="familiar">Familiar</option>
                                    <option value="negocios">Negocios</option>
                                    <option value="gastronomico">Gastronómico</option>
                                </select>
                                <small class="form-text text-muted">Seleccione el tipo de viaje preferido</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnGuardar">Guardar</button>
                    <button type="button" class="btn btn-success" id="btnActualizar"
                        style="display: none;">Actualizar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Funciones para iconos y colores
        function getClimaIcon(clima) {
            switch (clima) {
                case 'tropical': return '';
                case 'templado': return '';
                case 'frio': return '';
                case 'cualquiera': return '';
                default: return '';
            }
        }

        function getTipoViajeIcon(tipo) {
            switch (tipo) {
                case 'aventura': return '';
                case 'relax': return '';
                case 'cultural': return '';
                case 'romantico': return '';
                case 'familiar': return '';
                case 'negocios': return '';
                case 'gastronomico': return '';
                default: return '';
            }
        }

        function getPresupuestoColor(presupuesto) {
            if (!presupuesto) return 'bg-secondary';
            if (presupuesto < 1000) return 'bg-success';
            if (presupuesto < 3000) return 'bg-warning';
            return 'bg-danger';
        }

        const API_URL = 'http://localhost:3000/api/clientes/';

        // Cargar datos
        function cargarDatos() {
            $.get(API_URL, function (data) {
                $('#listadatos').empty();
                data.forEach(cliente => {
                    const preferencias = cliente.preferencias || {};
                    const climaIcon = getClimaIcon(preferencias.clima);
                    const tipoViajeIcon = getTipoViajeIcon(preferencias.tipo_viaje);
                    const presupuestoColor = getPresupuestoColor(preferencias.presupuesto_max);
                    const fecha = new Date(cliente.fecha_registro).toLocaleDateString('es-ES');

                    $('#listadatos').append(`
                        <tr>
                            <td>${cliente.nombre}</td>
                            <td>${cliente.correo}</td>
                            <td>${cliente.telefono}</td>
                            <td>${climaIcon} ${preferencias.clima || 'N/A'}</td>
                            <td><span class="badge ${presupuestoColor}">$${preferencias.presupuesto_max || 'N/A'}</span></td>
                            <td>${tipoViajeIcon} ${preferencias.tipo_viaje || 'N/A'}</td>
                            <td>${fecha}</td>
                            <td>
                                <button class="btn btn-primary btn-sm me-1" onclick="editarCliente('${cliente._id}')">
                                    Editar
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="eliminarCliente('${cliente._id}')">
                                    Eliminar
                                </button>
                            </td>
                        </tr>
                    `);
                });
            });
        }

        // Nuevo cliente
        $('#btnNuevo').click(function () {
            $('#modalClienteLabel').text('Agregar Cliente');
            $('#formCliente')[0].reset();
            $('#clienteId').val('');
            $('#btnGuardar').show();
            $('#btnActualizar').hide();
            $('#modalCliente').modal('show');
        });

        // Guardar cliente
        $('#formCliente').submit(function (e) {
            e.preventDefault();

            const cliente = {
                nombre: $('#nombre').val(),
                correo: $('#correo').val(),
                telefono: $('#telefono').val(),
                preferencias: {
                    clima: $('#clima').val(),
                    presupuesto_max: parseInt($('#presupuesto_max').val()) || 0,
                    tipo_viaje: $('#tipo_viaje').val()
                }
            };

            $.ajax({
                url: API_URL,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(cliente),
                success: function () {
                    alert('Cliente guardado exitosamente');
                    $('#modalCliente').modal('hide');
                    cargarDatos();
                },
                error: function (xhr) {
                    alert('Error: ' + (xhr.responseJSON?.mensaje || 'Error al guardar'));
                }
            });
        });

        // Editar cliente
        function editarCliente(id) {
            $.get(API_URL + id, function (cliente) {
                $('#modalClienteLabel').text('Editar Cliente');
                $('#clienteId').val(cliente._id);
                $('#nombre').val(cliente.nombre);
                $('#correo').val(cliente.correo);
                $('#telefono').val(cliente.telefono);

                const preferencias = cliente.preferencias || {};
                $('#clima').val(preferencias.clima || '');
                $('#presupuesto_max').val(preferencias.presupuesto_max || '');
                $('#tipo_viaje').val(preferencias.tipo_viaje || '');

                $('#btnGuardar').hide();
                $('#btnActualizar').show();
                $('#modalCliente').modal('show');
            });
        }

        // Actualizar cliente
        $('#btnActualizar').click(function () {
            const id = $('#clienteId').val();
            const cliente = {
                nombre: $('#nombre').val(),
                correo: $('#correo').val(),
                telefono: $('#telefono').val(),
                preferencias: {
                    clima: $('#clima').val(),
                    presupuesto_max: parseInt($('#presupuesto_max').val()) || 0,
                    tipo_viaje: $('#tipo_viaje').val()
                }
            };

            $.ajax({
                url: API_URL + id,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(cliente),
                success: function () {
                    alert('Cliente actualizado exitosamente');
                    $('#modalCliente').modal('hide');
                    cargarDatos();
                },
                error: function (xhr) {
                    alert('Error: ' + (xhr.responseJSON?.mensaje || 'Error al actualizar'));
                }
            });
        });

        // Eliminar cliente
        function eliminarCliente(id) {
            if (confirm('¿Está seguro de que desea eliminar este cliente?')) {
                $.ajax({
                    url: API_URL + id,
                    type: 'DELETE',
                    success: function () {
                        alert('Cliente eliminado exitosamente');
                        cargarDatos();
                    },
                    error: function (xhr) {
                        alert('Error: ' + (xhr.responseJSON?.mensaje || 'Error al eliminar'));
                    }
                });
            }
        }

        // Cargar datos al iniciar
        $(document).ready(function () {
            cargarDatos();
        });
    </script>

    <!-- Bootstrap JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
</body>

</html>