<!doctype html>
<html lang="es">

<head>
    <title>Clientes - ViajaFácil</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body>
    <header>
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" id="navId" role="tablist">
            <li class="nav-item">
                <a href="#tab1Id" class="nav-link" data-bs-toggle="tab" aria-current="page">ViajaFácil</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle active" data-bs-toggle="dropdown" href="#" role="button"
                    aria-haspopup="true" aria-expanded="false">Módulos</a>
                <div class="dropdown-menu">
                    <a class="dropdown-item active" href="clientes.html">Clientes</a>
                    <a class="dropdown-item" href="paquetes.html">Paquetes</a>
                    <a class="dropdown-item" href="cotizacion.html">Cotizaciones</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#tab4Id">Reportes</a>
                </div>
            </li>
            <li class="nav-item" role="presentation">
                <a href="#tab5Id" class="nav-link" data-bs-toggle="tab">Configuración</a>
            </li>
            <li class="nav-item" role="presentation">
                <a href="#" class="nav-link disabled" data-bs-toggle="tab">Ayuda</a>
            </li>
        </ul>
    </header>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1>Gestión de Clientes</h1>
            <button class="btn btn-success" id="btnNuevo">Agregar Cliente</button>
        </div>

        <div class="table-responsive mt-4">
            <table class="table table-hover">
                <thead class="table-primary">
                    <tr>
                        <th>Nombre</th>
                        <th>Correo</th>
                        <th>Teléfono</th>
                        <th>Clima</th>
                        <th>Presupuesto Máx</th>
                        <th>Tipo de Viaje</th>
                        <th>Fecha Registro</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="listadatos"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal para agregar/editar cliente -->
    <div class="modal fade" id="modalCliente" tabindex="-1" aria-labelledby="modalClienteLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formCliente" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalClienteLabel">Agregar Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="clienteId">
                    <div class="mb-3">
                        <label>Nombre</label>
                        <input type="text" id="nombre" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Correo</label>
                        <input type="email" id="correo" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Teléfono</label>
                        <input type="text" id="telefono" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>Clima</label>
                        <input type="text" id="clima" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>Presupuesto Máx</label>
                        <input type="number" id="presupuesto_max" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>Tipo de Viaje</label>
                        <input type="text" id="tipo_viaje" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            const API_URL = "http://localhost:3000/api/clientes/";
            const modalCliente = new bootstrap.Modal(document.getElementById('modalCliente'));

            function cargarDatos() {
                $.get(API_URL, function (data) {
                    $("#listadatos").empty();
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach((cliente) => {
                            const fecha = cliente.fecha_registro ? new Date(cliente.fecha_registro).toLocaleDateString() : "N/A";
                            $("#listadatos").append(`
                        <tr>
                            <td>${cliente.nombre || "N/A"}</td>
                            <td>${cliente.correo || "N/A"}</td>
                            <td>${cliente.telefono || "N/A"}</td>
                            <td>${cliente.preferencias?.clima || "N/A"}</td>
                            <td>${cliente.preferencias?.presupuesto_max ? "$" + cliente.preferencias.presupuesto_max : "N/A"}</td>
                            <td>${cliente.preferencias?.tipo_viaje || "N/A"}</td>
                            <td>${fecha}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="editarCliente('${cliente._id}')">Editar</button>
                                <button class="btn btn-danger btn-sm" onclick="eliminarCliente('${cliente._id}')">Eliminar</button>
                            </td>
                        </tr>
                    `);
                        });
                    } else {
                        $("#listadatos").append(`<tr><td colspan="8" class="text-center">No hay clientes registrados</td></tr>`);
                    }
                }).fail(function (error) {
                    $("#listadatos").html(`<tr><td colspan="8" class="text-center text-danger">Error: ${error.statusText}</td></tr>`);
                });
            }

            // Nuevo cliente
            $("#btnNuevo").click(function () {
                $("#formCliente")[0].reset();
                $("#clienteId").val("");
                $("#modalClienteLabel").text("Agregar Cliente");
                modalCliente.show();
            });

            // Guardar cliente
            $("#formCliente").submit(function (e) {
                e.preventDefault();
                const id = $("#clienteId").val();
                const clienteData = {
                    nombre: $("#nombre").val(),
                    correo: $("#correo").val(),
                    telefono: $("#telefono").val(),
                    preferencias: {
                        clima: $("#clima").val(),
                        presupuesto_max: $("#presupuesto_max").val(),
                        tipo_viaje: $("#tipo_viaje").val()
                    },
                    fecha_registro: new Date()
                };

                if (id) {
                    $.ajax({
                        url: API_URL + id,
                        type: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify(clienteData),
                        success: function () {
                            modalCliente.hide();
                            cargarDatos();
                        }
                    });
                } else {
                    $.ajax({
                        url: API_URL,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(clienteData),
                        success: function () {
                            modalCliente.hide();
                            cargarDatos();
                        }
                    });
                }
            });

            // Función global para editar
            window.editarCliente = function (id) {
                $.get(API_URL + id, function (cliente) {
                    $("#clienteId").val(cliente._id);
                    $("#nombre").val(cliente.nombre);
                    $("#correo").val(cliente.correo);
                    $("#telefono").val(cliente.telefono);
                    $("#clima").val(cliente.preferencias?.clima || "");
                    $("#presupuesto_max").val(cliente.preferencias?.presupuesto_max || "");
                    $("#tipo_viaje").val(cliente.preferencias?.tipo_viaje || "");
                    $("#modalClienteLabel").text("Editar Cliente");
                    modalCliente.show();
                });
            };

            // Función global para eliminar
            window.eliminarCliente = function (id) {
                if (confirm("¿Está seguro de que desea eliminar este cliente?")) {
                    $.ajax({
                        url: API_URL + id,
                        type: 'DELETE',
                        success: function () {
                            cargarDatos();
                        }
                    });
                }
            };

            // Cargar al inicio
            cargarDatos();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>