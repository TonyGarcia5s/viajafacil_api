<!doctype html>
<html lang="es">

<head>
    <title>Gestión de Clientes - ViajaFácil</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap CSS v5.2.1 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

</head>

<body>
    <header>
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" id="navId" role="tablist">
            <li class="nav-item">
                <a href="#tab1Id" class="nav-link active" data-bs-toggle="tab" aria-current="page">ViajaFácil</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                    aria-haspopup="true" aria-expanded="false">Módulos</a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="clientes.html">Clientes</a>
                    <a class="dropdown-item" href="paquetes.html">Paquetes</a>
                    <a class="dropdown-item" href="cotizacion.html">Cotizaciones</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#tab4Id">Reportes</a>
                </div>
            </li>
            <li class="nav-item" role="presentation">
                <a href="#tab5Id" class="nav-link" data-bs-toggle="tab">Configuración</a>
            </li>
            <li class="nav-item" role="presentation">
                <a href="#" class="nav-link disabled" data-bs-toggle="tab">Ayuda</a>
            </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="tab1Id" role="tabpanel">

            </div>
            <div class="tab-pane fade" id="tab2Id" role="tabpanel"></div>
            <div class="tab-pane fade" id="tab3Id" role="tabpanel"></div>
            <div class="tab-pane fade" id="tab4Id" role="tabpanel"></div>
            <div class="tab-pane fade" id="tab5Id" role="tabpanel"></div>
        </div>

    </header>
    <div class="container">
        <h1>Gestión de Clientes</h1>

        <div class="container">

            <div class="mb-3">
                <label for="nombre" class="form-label">Nombre</label>
                <input type="text" class="form-control" name="nombre" id="nombre" aria-describedby="helpId"
                    placeholder="Ingrese el nombre completo" />
                <small id="helpId" class="form-text text-muted">Ingrese el nombre completo del cliente</small>
            </div>
            <div class="mb-3">
                <label for="correo" class="form-label">Correo Electrónico</label>
                <input type="email" class="form-control" name="correo" id="correo" aria-describedby="helpId"
                    placeholder="ejemplo@email.com" />
                <small id="helpId" class="form-text text-muted">Ingrese el correo electrónico</small>
            </div>
            <div class="mb-3">
                <label for="telefono" class="form-label">Teléfono</label>
                <input type="tel" class="form-control" name="telefono" id="telefono" aria-describedby="helpId"
                    placeholder="+506 8888-8888" />
                <small id="helpId" class="form-text text-muted">Ingrese el número de teléfono</small>
            </div>
            <div class="mb-3">
                <label for="clima" class="form-label">Clima Preferido</label>
                <select class="form-select" name="clima" id="clima" aria-describedby="helpId">
                    <option value="">Seleccione clima preferido</option>
                    <option value="tropical">🌴 Tropical</option>
                    <option value="templado">🍃 Templado</option>
                    <option value="frio">❄️ Frío</option>
                    <option value="cualquiera">🌍 Cualquiera</option>
                </select>
                <small id="helpId" class="form-text text-muted">Seleccione el clima preferido para el viaje</small>
            </div>
            <div class="mb-3">
                <label for="presupuesto_max" class="form-label">Presupuesto Máximo</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" class="form-control" name="presupuesto_max" id="presupuesto_max" 
                        aria-describedby="helpId" placeholder="2000" min="0" step="100" />
                </div>
                <small id="helpId" class="form-text text-muted">Ingrese el presupuesto máximo en dólares</small>
            </div>
            <div class="mb-3">
                <label for="tipo_viaje" class="form-label">Tipo de Viaje</label>
                <select class="form-select" name="tipo_viaje" id="tipo_viaje" aria-describedby="helpId">
                    <option value="">Seleccione tipo de viaje</option>
                    <option value="aventura">🏔️ Aventura</option>
                    <option value="relax">🏖️ Relax</option>
                    <option value="cultural">🏛️ Cultural</option>
                    <option value="romantico">💕 Romántico</option>
                    <option value="familiar">👨‍👩‍👧‍👦 Familiar</option>
                    <option value="negocios">💼 Negocios</option>
                    <option value="gastronomico">🍽️ Gastronómico</option>
                </select>
                <small id="helpId" class="form-text text-muted">Seleccione el tipo de viaje preferido</small>
            </div>
            <div class="mb-3">
                <label for="cliente_id" class="form-label">ID Cliente</label>
                <input type="text" class="form-control" name="cliente_id" id="cliente_id" aria-describedby="helpId" 
                    placeholder="" readonly />
                <small id="helpId" class="form-text text-muted">ID del cliente (se genera automáticamente)</small>
            </div>
            <div class="mb-3">
                <a name="guardardatos" id="guardardatos" class="btn btn-primary" role="button">Guardar</a>

                <a name="actualizardatos" id="actualizardatos" class="btn btn-success" style="display: none;"
                    role="button">Actualizar</a>

                <input onclick="limpiarFormulario()" class="btn btn-danger" type="button" value="Limpiar" />

            </div>

        </div>

        <div class="table-responsive">
            <table class="table table-primary">
                <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Nombre</th>
                        <th scope="col">Correo</th>
                        <th scope="col">Teléfono</th>
                        <th scope="col">Clima</th>
                        <th scope="col">Presupuesto</th>
                        <th scope="col">Tipo Viaje</th>
                        <th scope="col">Acciones</th>
                    </tr>
                </thead>
                <tbody id="listadatos">

                </tbody>
            </table>
        </div>

    </div>
    <footer>
        <!-- place footer here -->
    </footer>

    <script>

        function limpiarFormulario() {
            $("#cliente_id").val("");
            $("#nombre").val("");
            $("#correo").val("");
            $("#telefono").val("");
            $("#clima").val("");
            $("#presupuesto_max").val("");
            $("#tipo_viaje").val("");
            $("#guardardatos").show();
            $("#actualizardatos").hide();
        }

        $(document).ready(function () {

            const API_URL = 'http://localhost:3000/api/clientes/';

            //Funciones

            function cargarDatos() {
                $.get(API_URL, function (data) {
                    console.log(data);
                    $("#listadatos").empty();
                    data.forEach((item) => {
                        const preferencias = item.preferencias || {};
                        const climaIcon = getClimaIcon(preferencias.clima);
                        const tipoViajeIcon = getTipoViajeIcon(preferencias.tipo_viaje);
                        const presupuestoColor = getPresupuestoColor(preferencias.presupuesto_max);
                        
                        $("#listadatos").append(
                            `<tr class="">
                            <td scope="row">${item._id}</td>
                            <td>${item.nombre || 'N/A'}</td>
                            <td>${item.correo || 'N/A'}</td>
                            <td>${item.telefono || 'N/A'}</td>
                            <td>${climaIcon} ${preferencias.clima || 'N/A'}</td>
                            <td><span class="badge ${presupuestoColor}">$${preferencias.presupuesto_max || 'N/A'}</span></td>
                            <td>${tipoViajeIcon} ${preferencias.tipo_viaje || 'N/A'}</td>
                            <td>
                                <a
                                    name=""
                                    id=""
                                    class="btn btn-primary btn-sm"
                                    onclick="editarDatos('${item._id}','${item.nombre || ''}','${item.correo || ''}','${item.telefono || ''}','${preferencias.clima || ''}','${preferencias.presupuesto_max || ''}','${preferencias.tipo_viaje || ''}')"
                                    role="button"
                                    >Editar</a
                                >
                                
                                <a
                                    name=""
                                    id=""
                                    class="btn btn-danger btn-sm"
                                    onclick="eliminarDatos('${item._id}')"
                                    role="button"
                                    >Eliminar</a
                                >

                            </td>
                        </tr>`);
                    });
                });
            }

            //guardardatos
            $("#guardardatos").click(function (e) {

                const nuevoDato = {
                    nombre: $("#nombre").val(),
                    correo: $("#correo").val(),
                    telefono: $("#telefono").val(),
                    preferencias: {
                        clima: $("#clima").val(),
                        presupuesto_max: $("#presupuesto_max").val(),
                        tipo_viaje: $("#tipo_viaje").val()
                    }
                };

                $.ajax({
                    url: API_URL,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(nuevoDato),
                    success: function () {
                        alert("Cliente creado exitosamente");
                        limpiarFormulario();
                        cargarDatos();
                    },
                    error: function (err) {
                        alert('Error al crear cliente: ' + err.responseJSON?.mensaje || err.statusText);
                    }
                });
            });

            //actualizardatos
            $("#actualizardatos").click(function (e) {
                const clienteId = $("#cliente_id").val();
                
                const datosActualizados = {
                    nombre: $("#nombre").val(),
                    correo: $("#correo").val(),
                    telefono: $("#telefono").val(),
                    preferencias: {
                        clima: $("#clima").val(),
                        presupuesto_max: $("#presupuesto_max").val(),
                        tipo_viaje: $("#tipo_viaje").val()
                    }
                };

                $.ajax({
                    url: API_URL + clienteId,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(datosActualizados),
                    success: function () {
                        alert("Cliente actualizado exitosamente");
                        limpiarFormulario();
                        cargarDatos();
                    },
                    error: function (err) {
                        alert('Error al actualizar cliente: ' + err.responseJSON?.mensaje || err.statusText);
                    }
                });
            });

            //Fin de funciones y eventos    

            cargarDatos();

        });

        window.editarDatos = function (id, nombre, correo, telefono, clima, presupuesto_max, tipo_viaje) {
            $("#cliente_id").val(id);
            $("#nombre").val(nombre);
            $("#correo").val(correo);
            $("#telefono").val(telefono);
            $("#clima").val(clima);
            $("#presupuesto_max").val(presupuesto_max);
            $("#tipo_viaje").val(tipo_viaje);
            $("#guardardatos").hide();
            $("#actualizardatos").show();
        }

        window.eliminarDatos = function (id) {
            if (confirm("¿Está seguro de que desea eliminar este cliente?")) {
                $.ajax({
                    url: 'http://localhost:3000/api/clientes/' + id,
                    type: 'DELETE',
                    success: function () {
                        alert("Cliente eliminado exitosamente");
                        cargarDatos();
                    },
                    error: function (err) {
                        alert('Error al eliminar cliente: ' + err.responseJSON?.mensaje || err.statusText);
                    }
                });
            }
        }

        // Función para obtener el icono del clima
        function getClimaIcon(clima) {
            switch(clima) {
                case 'tropical': return '🌴';
                case 'templado': return '🍃';
                case 'frio': return '❄️';
                case 'cualquiera': return '🌍';
                default: return '🌤️';
            }
        }

        // Función para obtener el icono del tipo de viaje
        function getTipoViajeIcon(tipo) {
            switch(tipo) {
                case 'aventura': return '🏔️';
                case 'relax': return '🏖️';
                case 'cultural': return '🏛️';
                case 'romantico': return '💕';
                case 'familiar': return '👨‍👩‍👧‍👦';
                case 'negocios': return '💼';
                case 'gastronomico': return '🍽️';
                default: return '✈️';
            }
        }

        // Función para obtener el color del badge según el presupuesto
        function getPresupuestoColor(presupuesto) {
            if (!presupuesto) return 'bg-secondary';
            if (presupuesto < 1000) return 'bg-success';
            if (presupuesto < 3000) return 'bg-warning';
            return 'bg-danger';
        }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>
</body>

</html>
