<!doctype html>
<html lang="es">

<head>
    <title>Gesti√≥n de Cotizaciones - ViajaF√°cil</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap CSS v5.2.1 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

</head>

<body>
    <header>
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" id="navId" role="tablist">
            <li class="nav-item">
                <a href="#tab1Id" class="nav-link active" data-bs-toggle="tab" aria-current="page">ViajaF√°cil</a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                    aria-haspopup="true" aria-expanded="false">M√≥dulos</a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="clientes.html">Clientes</a>
                    <a class="dropdown-item" href="paquetes.html">Paquetes</a>
                    <a class="dropdown-item" href="cotizacion.html">Cotizaciones</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#tab4Id">Reportes</a>
                </div>
            </li>
            <li class="nav-item" role="presentation">
                <a href="#tab5Id" class="nav-link" data-bs-toggle="tab">Configuraci√≥n</a>
            </li>
            <li class="nav-item" role="presentation">
                <a href="#" class="nav-link disabled" data-bs-toggle="tab">Ayuda</a>
            </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="tab1Id" role="tabpanel">

            </div>
            <div class="tab-pane fade" id="tab2Id" role="tabpanel"></div>
            <div class="tab-pane fade" id="tab3Id" role="tabpanel"></div>
            <div class="tab-pane fade" id="tab4Id" role="tabpanel"></div>
            <div class="tab-pane fade" id="tab5Id" role="tabpanel"></div>
        </div>

    </header>
    <div class="container">
        <h1>Gesti√≥n de Cotizaciones</h1>
        
        <!-- Bot√≥n para abrir modal -->
        <div class="mb-3">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cotizacionModal">
                <i class="bi bi-plus-circle"></i> Nueva Cotizaci√≥n
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-primary">
                <thead>
                    <tr>
                        <th scope="col">ID</th>
                        <th scope="col">Cliente</th>
                        <th scope="col">Paquete</th>
                        <th scope="col">Precio Final</th>
                        <th scope="col">Estado</th>
                        <th scope="col">Fecha</th>
                        <th scope="col">Acciones</th>
                    </tr>
                </thead>
                <tbody id="listadatos">

                </tbody>
            </table>
        </div>

    </div>

    <!-- Modal para Cotizaci√≥n -->
    <div class="modal fade" id="cotizacionModal" tabindex="-1" aria-labelledby="cotizacionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cotizacionModalLabel">Nueva Cotizaci√≥n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="cotizacionForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cliente_id" class="form-label">Cliente</label>
                                    <select class="form-select" name="cliente_id" id="cliente_id" required>
                                        <option value="">Seleccione un cliente</option>
                                    </select>
                                    <small class="form-text text-muted">Seleccione el cliente</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="paquete_id" class="form-label">Paquete</label>
                                    <select class="form-select" name="paquete_id" id="paquete_id" required>
                                        <option value="">Seleccione un paquete</option>
                                    </select>
                                    <small class="form-text text-muted">Seleccione el paquete</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="precio_final" class="form-label">Precio Final</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" name="precio_final" id="precio_final" 
                                            placeholder="0.00" min="0" step="0.01" required />
                                    </div>
                                    <small class="form-text text-muted">Ingrese el precio final</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="estado" class="form-label">Estado</label>
                                    <select class="form-select" name="estado" id="estado" required>
                                        <option value="">Seleccione estado</option>
                                        <option value="pendiente">‚è≥ Pendiente</option>
                                        <option value="aprobada">‚úÖ Aprobada</option>
                                        <option value="rechazada">‚ùå Rechazada</option>
                                        <option value="cancelada">üö´ Cancelada</option>
                                    </select>
                                    <small class="form-text text-muted">Seleccione el estado</small>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="detalles_adicionales" class="form-label">Detalles Adicionales</label>
                            <textarea class="form-control" name="detalles_adicionales" id="detalles_adicionales" 
                                rows="3" placeholder="Detalles adicionales de la cotizaci√≥n"></textarea>
                            <small class="form-text text-muted">Ingrese detalles adicionales (opcional)</small>
                        </div>
                        <input type="hidden" id="cotizacion_id" name="cotizacion_id" />
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="guardarCotizacion">Guardar</button>
                    <button type="button" class="btn btn-success" id="actualizarCotizacion" style="display: none;">Actualizar</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <!-- place footer here -->
    </footer>

    <script>

        function limpiarFormulario() {
            $("#cotizacion_id").val("");
            $("#cliente_id").val("");
            $("#paquete_id").val("");
            $("#precio_final").val("");
            $("#estado").val("");
            $("#detalles_adicionales").val("");
            $("#guardarCotizacion").show();
            $("#actualizarCotizacion").hide();
            $("#cotizacionModalLabel").text("Nueva Cotizaci√≥n");
        }

        // Funci√≥n para obtener icono del estado
        function getEstadoIcon(estado) {
            switch(estado) {
                case 'pendiente': return '‚è≥';
                case 'aprobada': return '‚úÖ';
                case 'rechazada': return '‚ùå';
                case 'cancelada': return 'üö´';
                default: return '‚ùì';
            }
        }

        // Funci√≥n para obtener color del badge del estado
        function getEstadoColor(estado) {
            switch(estado) {
                case 'pendiente': return 'bg-warning';
                case 'aprobada': return 'bg-success';
                case 'rechazada': return 'bg-danger';
                case 'cancelada': return 'bg-secondary';
                default: return 'bg-info';
            }
        }

        $(document).ready(function () {

            const API_URL = 'http://localhost:3000/api/cotizaciones/';

            // Cargar clientes y paquetes en los dropdowns
            function cargarClientes() {
                $.get('http://localhost:3000/api/clientes/', function (data) {
                    $("#cliente_id").empty().append('<option value="">Seleccione un cliente</option>');
                    data.forEach((cliente) => {
                        $("#cliente_id").append(`<option value="${cliente._id}">${cliente.nombre} (${cliente.correo})</option>`);
                    });
                });
            }

            function cargarPaquetes() {
                $.get('http://localhost:3000/api/paquetes/', function (data) {
                    $("#paquete_id").empty().append('<option value="">Seleccione un paquete</option>');
                    data.forEach((paquete) => {
                        $("#paquete_id").append(`<option value="${paquete._id}">${paquete.nombre} - $${paquete.precio}</option>`);
                    });
                });
            }

            // Cargar datos de cotizaciones
            function cargarDatos() {
                console.log("Cargando datos de cotizaciones...");
                $.get(API_URL, function (data) {
                    console.log("Datos recibidos:", data);
                    $("#listadatos").empty();
                    if (data && data.length > 0) {
                        data.forEach((item) => {
                            const fecha = new Date(item.fecha_creacion).toLocaleDateString('es-ES');
                            const estadoIcon = getEstadoIcon(item.estado);
                            const estadoColor = getEstadoColor(item.estado);
                            
                            $("#listadatos").append(
                                `<tr class="">
                                <td scope="row">${item._id}</td>
                                <td>${item.cliente ? item.cliente.nombre : 'N/A'}</td>
                                <td>${item.paquete ? item.paquete.nombre : 'N/A'}</td>
                                <td><span class="badge bg-primary">$${item.precio_final || 'N/A'}</span></td>
                                <td><span class="badge ${estadoColor}">${estadoIcon} ${item.estado || 'N/A'}</span></td>
                                <td>${fecha}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="editarCotizacion('${item._id}')">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="eliminarCotizacion('${item._id}')">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </td>
                            </tr>`);
                        });
                    } else {
                        $("#listadatos").append('<tr><td colspan="7" class="text-center">No hay cotizaciones registradas</td></tr>');
                    }
                }).fail(function(xhr, status, error) {
                    console.error("Error al cargar datos:", error);
                    $("#listadatos").append('<tr><td colspan="7" class="text-center text-danger">Error al cargar datos</td></tr>');
                });
            }

            // Guardar nueva cotizaci√≥n
            $("#guardarCotizacion").click(function () {
                const nuevaCotizacion = {
                    cliente_id: $("#cliente_id").val(),
                    paquete_id: $("#paquete_id").val(),
                    precio_final: parseFloat($("#precio_final").val()),
                    estado: $("#estado").val(),
                    detalles_adicionales: $("#detalles_adicionales").val()
                };

                $.ajax({
                    url: API_URL,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(nuevaCotizacion),
                    success: function (response) {
                        alert("Cotizaci√≥n guardada exitosamente");
                        $('#cotizacionModal').modal('hide');
                        limpiarFormulario();
                        cargarDatos();
                    },
                    error: function (xhr, status, error) {
                        console.error("Error:", xhr.responseText);
                        alert('Error al guardar: ' + (xhr.responseJSON?.mensaje || error));
                    }
                });
            });

            // Actualizar cotizaci√≥n
            $("#actualizarCotizacion").click(function () {
                const cotizacionId = $("#cotizacion_id").val();
                if (!cotizacionId) {
                    alert("No hay cotizaci√≥n seleccionada para actualizar");
                    return;
                }

                const cotizacionActualizada = {
                    cliente_id: $("#cliente_id").val(),
                    paquete_id: $("#paquete_id").val(),
                    precio_final: parseFloat($("#precio_final").val()),
                    estado: $("#estado").val(),
                    detalles_adicionales: $("#detalles_adicionales").val()
                };

                $.ajax({
                    url: API_URL + cotizacionId,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(cotizacionActualizada),
                    success: function (response) {
                        alert("Cotizaci√≥n actualizada exitosamente");
                        $('#cotizacionModal').modal('hide');
                        limpiarFormulario();
                        cargarDatos();
                    },
                    error: function (xhr, status, error) {
                        console.error("Error:", xhr.responseText);
                        alert('Error al actualizar: ' + (xhr.responseJSON?.mensaje || error));
                    }
                });
            });

            // Funci√≥n para editar cotizaci√≥n
            window.editarCotizacion = function (id) {
                $.get(API_URL + id, function (data) {
                    $("#cotizacion_id").val(data._id);
                    $("#cliente_id").val(data.cliente_id);
                    $("#paquete_id").val(data.paquete_id);
                    $("#precio_final").val(data.precio_final);
                    $("#estado").val(data.estado);
                    $("#detalles_adicionales").val(data.detalles_adicionales);
                    
                    $("#guardarCotizacion").hide();
                    $("#actualizarCotizacion").show();
                    $("#cotizacionModalLabel").text("Editar Cotizaci√≥n");
                    
                    $('#cotizacionModal').modal('show');
                });
            }

            // Funci√≥n para eliminar cotizaci√≥n
            window.eliminarCotizacion = function (id) {
                if (confirm("¬øEst√° seguro de que desea eliminar esta cotizaci√≥n?")) {
                    $.ajax({
                        url: API_URL + id,
                        type: 'DELETE',
                        success: function (response) {
                            alert("Cotizaci√≥n eliminada exitosamente");
                            cargarDatos();
                        },
                        error: function (xhr, status, error) {
                            console.error("Error:", xhr.responseText);
                            alert('Error al eliminar: ' + (xhr.responseJSON?.mensaje || error));
                        }
                    });
                }
            }

            // Limpiar formulario cuando se cierra el modal
            $('#cotizacionModal').on('hidden.bs.modal', function () {
                limpiarFormulario();
            });

            // Inicializar
            cargarClientes();
            cargarPaquetes();
            cargarDatos();
        });
    </script>

    <!-- Bootstrap JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
</body>

</html>
